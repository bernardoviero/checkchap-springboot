<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TAREFA</title>
    <script th:inline="javascript">
        var nomeUrl = "[[${nome}]]";

        if (!nomeUrl) {
            var url = window.location.href.replace("/tarefa", "");
            window.history.pushState("", "", url);
        }
    </script>
</head>
<body>
<form th:action="@{{id}(id=${id})}" method="post">
    <input type="hidden" name="_method" value="put" />
    <input type="hidden" name="id" th:value="${id}" />
    <input type="text" name="titulo" value="" th:value="${tituloTarefa}" onkeydown="verificarEnter(event)">
</form>

<form id="checklistForm" th:action="@{/item/criar/{idTarefa}(idTarefa=${id})}" method="post">
    <input type="text" name=nomeItem id="checklistItemInput" placeholder="Item 1" onkeyup="verificarEnter(event)">
    <input type="button" id="addItemBtn" style="display: none;">
</form>

<div id="checklistItemsContainer">
    <!-- Iterar sobre os itens e renderizá-los -->
    <div th:each="item : ${itens}" class="checklist-item">
        <input type="checkbox" name="checklistItem" th:value="${item.item}" th:checked="${item.situacao}" th:attr="data-idItem=${item.id}" onchange="enviarRequisicao(this)">
        <label th:text="${item.item}"></label>
        <a th:href="@{/item/excluir/{idItem}(idItem=${item.id})}">Excluir</a>
    </div>
</div>

<script>
    console.log(item.item)
    function verificarEnter(event) {
        if (event.key === "Enter") {
            event.preventDefault();

            const input = event.target;
            const newItem = input.value.trim();

            if (newItem !== "") {
                const form = input.closest("form");
                if (form.id === "checklistForm") {
                    const div = document.createElement("div");
                    div.className = "checklist-item";

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.name = "checklistItem";
                    checkbox.value = newItem;

                    const label = document.createElement("label");
                    label.appendChild(document.createTextNode(newItem));

                    const hiddenInput = document.createElement("input");
                    hiddenInput.type = "hidden";
                    hiddenInput.name = "checklistItems";
                    hiddenInput.value = newItem;

                    div.appendChild(checkbox);
                    div.appendChild(label);
                    div.appendChild(hiddenInput);

                    form.insertBefore(div, input);
                    input.value = "";
                    input.focus();

                    // Atualizar o valor do campo de entrada do checklist no formulário
                    const checklistItemInput = document.getElementById("checklistItemInput");
                    checklistItemInput.value = newItem;

                    // Acionar o botão de adicionar item
                    const addItemBtn = document.getElementById("addItemBtn");
                    addItemBtn.click();
                }else{
                    event.preventDefault();

                    const form = event.target.closest("form");
                    form.submit();
                }
            }
        }
    }
    function enviarRequisicao(checkbox) {
        var idItem = checkbox.getAttribute("data-idItem");
        console.log(idItem)
        var situacao = checkbox.checked ? 1 : 0;
    
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/item/alterarSituacao/" + idItem + "?situacao=" + situacao, true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                // A requisição foi concluída com sucesso
                console.log("Requisição enviada com sucesso");
            }
        };
        xhr.send();
    }
</script>
</body>
</html>